{% extends "base.html" %}
{% block title %}–ö–æ–º–∞–Ω–¥—ã{% endblock %}
{% block content %}
<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
    <h1 style="margin: 0;">–°–æ—á–µ—Ç–∞–Ω–∏—è –∫–ª–∞–≤–∏—à</h1>
    <button id="add-command-btn" type="button">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ—á–µ—Ç–∞–Ω–∏–µ</button>
</div>
<form id="hotkeys-form">
    <div id="hotkeys-list"></div>
    <div class="btn-with-status" style="margin-top: 24px;">
        <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <div id="save-status"></div>
    </div>
</form>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã -->
<div id="modal-bg" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#181d27; padding:32px 24px; border-radius:12px; min-width:320px; box-shadow:0 2px 12px #000;">
        <h2 style="margin-top:0;">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É</h2>
        <form id="add-command-form">
            <label>
                <span>üîë –ù–∞–∑–≤–∞–Ω–∏–µ:</span>
                <input type="text" name="title" required>
                <p class="hint">*–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã (–ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ)</p>
            </label>
            <label>
                <span>üïπÔ∏è –¢—Ä–∏–≥–≥–µ—Ä—ã:</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div id="add-target-fields" class="target-fields-list"></div>
                    <button type="button" id="add-target-btn" class="btn btn-secondary btn-sm mb-2 add-target-btn" style="margin-top:0;">‚ûï</button>
                    <p class="hint target-hint" style="margin: 0 0 0 8px;">*–ö–∞–∂–¥—ã–π —Ç—Ä–∏–≥–≥–µ—Ä –æ—Ç–¥–µ–ª—å–Ω—ã–º –ø–æ–ª–µ–º</p>
                </div>
            </label>
            <label>
                <span>üí≠ –ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</span>
                <input type="text" name="words" required>
                <p class="hint">*–§—Ä–∞–∑—ã –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</p>
            </label>
            <label>
                <span>‚å®Ô∏è –°–æ—á–µ—Ç–∞–Ω–∏–µ –∫–ª–∞–≤–∏—à:</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div id="add-hotkey-fields" class="hotkey-fields-list"></div>
                    <button type="button" id="add-hotkey-btn" class="btn btn-secondary btn-sm mb-2 add-hotkey-btn" style="margin-top:0;">‚ûï</button>
                    <p class="hint hotkey-hint" style="margin: 0 0 0 8px;">*–ö–∞–∂–¥–∞—è –∫–ª–∞–≤–∏—à–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–º –ø–æ–ª–µ–º</p>
                </div>
            </label>
            <label style="display: block; width: 100%;">
                <span style="display: block; margin-bottom: 6px;">üìå –§–ª–∞–≥ –æ–∑–≤—É—á–∫–∏:</span>
                <select name="flag" id="add-flag-select" style="width: 100%; box-sizing: border-box;">
                    <option value="">–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</option>
                </select>
                <p class="hint" style="margin-top: 4px;">*–§–ª–∞–≥ –æ–∑–≤—É—á–∫–∏ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã</p>
            </label>
            <div style="display:flex; gap:12px; margin-top:16px;">
                <button type="submit">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                <button type="button" id="close-modal-btn">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div id="add-status"></div>
        </form>
    </div>
</div>

<style>
.hotkey-fields-list, #add-hotkey-fields,
.target-fields-list, #add-target-fields {
    display: flex !important;
    flex-direction: row !important;
    gap: 8px;
    align-items: center;
    margin-bottom: 4px;
}
.hotkey-field-row, .target-field-row {
    display: flex;
    align-items: center;
    margin-bottom: 0;
}
.add-hotkey-btn, #add-hotkey-btn,
.add-target-btn, #add-target-btn {
    padding: 6px;
    font-size: 18px;
    min-width: 28px;
    min-height: 28px;
    border-radius: 6px;
    background: #222b3a;
    color: #4fa3ff;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 8px;
}
.add-hotkey-btn:hover, #add-hotkey-btn:hover,
.add-target-btn:hover, #add-target-btn:hover {
    background: #26314a;
}
.remove-hotkey-btn, .remove-target-btn {
    padding: 2px 6px;
    font-size: 16px;
    min-width: 24px;
    min-height: 24px;
    border-radius: 6px;
    background: #2a2a2a;
    color: #ff4f4f;
    border: none;
    cursor: pointer;
    margin-left: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.remove-hotkey-btn:hover, .remove-target-btn:hover {
    background: #3a2323;
}
.label-flex {
    display: flex;
    align-items: center;
}
.label-flex > span {
    align-items: center;
    display: flex;
    height: 32px;
}
.hotkey-hint {
    display: flex;
    align-items: center;
    height: 32px;
}
</style>

<script>
let commandsData = {};
let voiceFlags = [];

async function loadCommands() {
    const resp = await axios.get('/api/hotkeys');
    commandsData = resp.data;
    await loadVoiceFlags();
    renderCommands();
}

async function loadVoiceFlags() {
    const resp = await axios.get('/api/voice/flags');
    voiceFlags = resp.data;
}

function renderHotkeyFields(hotkeyArr, idx) {
    let html = '';
    if (!Array.isArray(hotkeyArr) || hotkeyArr.length === 0) hotkeyArr = [''];
    hotkeyArr.forEach((key, i) => {
        html += `<div class="hotkey-field-row" style="display:flex;align-items:center;margin-bottom:0px;">
            <input type="text" name="hotkey" value="${key}" data-idx="${idx}" class="lg-input hotkey-input" style="width:120px;">
            <button type="button" class="remove-hotkey-btn" style="margin-left:6px;">‚úñ</button>
        </div>`;
    });
    return html;
}

function renderTargetFields(targetArr, idx) {
    let html = '';
    if (!Array.isArray(targetArr) || targetArr.length === 0) targetArr = [''];
    targetArr.forEach((key, i) => {
        html += `<div class="target-field-row" style="display:flex;align-items:center;margin-bottom:0px;">
            <input type="text" name="target" value="${key}" data-idx="${idx}" class="lg-input target-input" style="width:120px;">
            <button type="button" class="remove-target-btn" style="margin-left:6px;">‚úñ</button>
        </div>`;
    });
    return html;
}

function renderCommands() {
    const list = document.getElementById('hotkeys-list');
    list.innerHTML = '';
    Object.entries(commandsData).forEach(([key, v], idx) => {
        let wordsValue = Array.isArray(v.words) ? v.words.join(', ') : (v.words || '');
        const block = document.createElement('div');
        block.className = 'data-block';
        block.style.marginBottom = '18px';
        block.innerHTML = `
            <div style="display: flex; justify-content: space-between; ">
                <div style="flex:1;">
                    <h3 style="margin:0 0 16px 0;">${key}</h3>
                    <div class="label-flex" style="margin-bottom: 4px;">
                        <span style="min-width:110px;">üïπÔ∏è –¢—Ä–∏–≥–≥–µ—Ä—ã:</span>
                        <div style="display: flex; align-items: flex-start; gap: 8px;align-items:center;">
                            <div class="target-fields-list" data-idx="${idx}" style="gap:8px;align-items:center;"></div>
                            <button type="button" class="add-target-btn" data-idx="${idx}">‚ûï</button>
                            <p class="hint target-hint" style="margin: 2px 0 0 8px; align-self: center;">*–ö–∞–∂–¥—ã–π —Ç—Ä–∏–≥–≥–µ—Ä –æ—Ç–¥–µ–ª—å–Ω—ã–º –ø–æ–ª–µ–º</p>
                        </div>
                    </div>
                    <div class="label-flex" style="margin-bottom: 8px;">
                        <span style="min-width:110px;">üí≠ –§—Ä–∞–∑—ã:</span>
                        <input type="text" name="words" value="${wordsValue}" data-idx="${idx}" required class="lg-input">
                        <p class="hint">*–§—Ä–∞–∑—ã –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</p>
                    </div>
                    <div class="label-flex" style="align-items: center;margin-bottom: 4px;">
                        <span style="min-width:110px;">‚å®Ô∏è –ö–ª–∞–≤–∏—à–∏:</span>
                        <div style="display: flex; align-items: flex-start; gap: 8px;align-items:center;">
                            <div class="hotkey-fields-list" data-idx="${idx}" style="gap:8px;align-items:center;"></div>
                            <button type="button" class="add-hotkey-btn" data-idx="${idx}">‚ûï</button>
                            <p class="hint hotkey-hint" style="margin: 2px 0 0 8px; align-self: flex-start;">*–ö–∞–∂–¥–∞—è –∫–ª–∞–≤–∏—à–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–º –ø–æ–ª–µ–º</p>
                        </div>
                    </div>
                    <div class="label-flex" style=" align-items: center;">
                        <span style="min-width:110px;">üìå –§–ª–∞–≥:</span>
                        <div class="flag-select-container" style="width:345px;"></div>
                        <p class="hint">*–§–ª–∞–≥ –æ–∑–≤—É—á–∫–∏ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã</p>
                    </div>
                </div>
                <div style="display: flex; align-items: center;">
                    <button type="button" class="delete-command-btn" data-key="${key}" style="background:#a33;">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
        `;
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
        const deleteBtn = block.querySelector('.delete-command-btn');
        deleteBtn.onclick = async function() {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫–æ–º–∞–Ω–¥—É \"${key}\"?`)) {
                try {
                    await axios.delete(`/api/hotkeys/${key}`);
                    loadCommands();
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è!');
                }
            }
        };
        // Hotkey add/remove
        const hotkeyFieldsList = block.querySelector('.hotkey-fields-list');
        hotkeyFieldsList.innerHTML = renderHotkeyFields(v.hotkey, idx);
        hotkeyFieldsList.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-hotkey-btn')) {
                e.target.parentElement.remove();
            }
        });
        block.querySelector('.add-hotkey-btn').onclick = function() {
            const div = document.createElement('div');
            div.className = 'hotkey-field-row';
            div.style = 'display:flex;align-items:center;'; //margin-bottom: 4px
            div.innerHTML = `<input type="text" name="hotkey" class="lg-input hotkey-input" style="width:120px;"><button type="button" class="remove-hotkey-btn">‚úñ</button>`;
            hotkeyFieldsList.appendChild(div);
        };
        // Target add/remove
        const targetFieldsList = block.querySelector('.target-fields-list');
        targetFieldsList.innerHTML = renderTargetFields(v.target, idx);
        targetFieldsList.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-target-btn')) {
                e.target.parentElement.remove();
            }
        });
        block.querySelector('.add-target-btn').onclick = function() {
            const div = document.createElement('div');
            div.className = 'target-field-row';
            div.style = 'display:flex;align-items:center;margin-bottom:0px;';
            div.innerHTML = `<input type="text" name="target" class="lg-input target-input" style="width:120px;"><button type="button" class="remove-target-btn">‚úñ</button>`;
            targetFieldsList.appendChild(div);
        };
        // –§–ª–∞–≥–∏
        const flagSelect = document.createElement('select');
        flagSelect.name = 'flag';
        flagSelect.className = 'lg-input';
        flagSelect.style = "width:345px;"
        flagSelect.setAttribute('data-idx', idx);
        const noneOption = document.createElement('option');
        noneOption.value = '';
        noneOption.textContent = '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
        if (!v.flag || v.flag === '') noneOption.selected = true;
        flagSelect.appendChild(noneOption);
        voiceFlags.forEach(flag => {
            const option = document.createElement('option');
            option.value = flag;
            option.textContent = flag;
            if (v.flag === flag) option.selected = true;
            flagSelect.appendChild(option);
        });
        const flagDiv = block.querySelector('.flag-select-container');
        flagDiv.appendChild(flagSelect);
        list.appendChild(block);
    });
}

// –ú–æ–¥–∞–ª–∫–∞
const modalBg = document.getElementById('modal-bg');
document.getElementById('add-command-btn').onclick = () => { fillAddFlagSelect(); modalBg.style.display = 'flex'; };
document.getElementById('close-modal-btn').onclick = () => { modalBg.style.display = 'none'; };

// –ó–∞–ø–æ–ª–Ω—è–µ–º select –≤ –º–æ–¥–∞–ª–∫–µ
function fillAddFlagSelect() {
    const addFlagSelect = document.getElementById('add-flag-select');
    addFlagSelect.innerHTML = '<option value="">–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</option>';
    voiceFlags.forEach(flag => {
        const option = document.createElement('option');
        option.value = flag;
        option.textContent = flag;
        addFlagSelect.appendChild(option);
    });
}

// Hotkey fields –≤ –º–æ–¥–∞–ª–∫–µ
function renderAddHotkeyFields() {
    const container = document.getElementById('add-hotkey-fields');
    container.innerHTML = '';
    const div = document.createElement('div');
    div.className = 'hotkey-field-row';
    div.style = 'display:flex;align-items:center;margin-bottom:0px;';
    div.innerHTML = `<input type="text" name="hotkey" class="lg-input hotkey-input" style="width:120px;"><button type="button" class="remove-hotkey-btn">‚úñ</button>`;
    container.appendChild(div);
}
renderAddHotkeyFields();
document.getElementById('add-hotkey-btn').onclick = function(e) {
    e.preventDefault();
    const container = document.getElementById('add-hotkey-fields');
    const div = document.createElement('div');
    div.className = 'hotkey-field-row';
    div.style = 'display:flex;align-items:center;margin-bottom:0px;';
    div.innerHTML = `<input type="text" name="hotkey" class="lg-input hotkey-input" style="width:120px;"><button type="button" class="remove-hotkey-btn">‚úñ</button>`;
    container.appendChild(div);
};
document.getElementById('add-hotkey-fields').addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-hotkey-btn')) {
        e.target.parentElement.remove();
    }
});

// Target fields –≤ –º–æ–¥–∞–ª–∫–µ
function renderAddTargetFields() {
    const container = document.getElementById('add-target-fields');
    container.innerHTML = '';
    const div = document.createElement('div');
    div.className = 'target-field-row';
    div.style = 'display:flex;align-items:center;margin-bottom:0px;';
    div.innerHTML = `<input type="text" name="target" class="lg-input target-input" style="width:120px;"><button type="button" class="remove-target-btn">‚úñ</button>`;
    container.appendChild(div);
}
renderAddTargetFields();
document.getElementById('add-target-btn').onclick = function(e) {
    e.preventDefault();
    const container = document.getElementById('add-target-fields');
    const div = document.createElement('div');
    div.className = 'target-field-row';
    div.style = 'display:flex;align-items:center;margin-bottom:0px;';
    div.innerHTML = `<input type="text" name="target" class="lg-input target-input" style="width:120px;"><button type="button" class="remove-target-btn">‚úñ</button>`;
    container.appendChild(div);
};
document.getElementById('add-target-fields').addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-target-btn')) {
        e.target.parentElement.remove();
    }
});

// –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–ª–∞–≥–æ–≤ –∑–∞–ø–æ–ª–Ω—è–µ–º select
async function loadAll() {
    await loadVoiceFlags();
    fillAddFlagSelect();
    await loadCommands();
}

// –ú–æ–¥–∞–ª–∫–∞: –æ–±–Ω–æ–≤–ª—è—Ç—å select –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
modalBg.addEventListener('show', fillAddFlagSelect);

document.getElementById('add-command-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const wordsRaw = form.words.value.trim();
    let words;
    if (wordsRaw === '') {
        words = [];
    } else if (wordsRaw.includes(',')) {
        words = wordsRaw.split(',').map(s => s.trim()).filter(Boolean);
    } else {
        words = [wordsRaw];
    }
    // –°–æ–±–∏—Ä–∞–µ–º —Ç—Ä–∏–≥–≥–µ—Ä—ã –∫–∞–∫ –º–∞—Å—Å–∏–≤
    const target = Array.from(form.querySelectorAll('input[name="target"]'))
        .map(input => input.value.trim())
        .filter(Boolean);
    // –°–æ–±–∏—Ä–∞–µ–º —Ö–æ—Ç–∫–µ–π –∫–∞–∫ –º–∞—Å—Å–∏–≤
    const hotkey = Array.from(form.querySelectorAll('input[name="hotkey"]'))
        .map(input => input.value.trim())
        .filter(Boolean);
    const data = {
        title: form.title.value.trim(),
        target,
        words,
        hotkey,
        flag: form.flag.value
    };
    try {
        await axios.post('/api/hotkeys', data);
        document.getElementById('add-status').textContent = '–î–æ–±–∞–≤–ª–µ–Ω–æ!';
        form.reset();
        renderAddTargetFields();
        renderAddHotkeyFields();
        setTimeout(() => {
            document.getElementById('add-status').textContent = '';
            modalBg.style.display = 'none';
        }, 1000);
        loadCommands();
    } catch (err) {
        document.getElementById('add-status').textContent = '–û—à–∏–±–∫–∞!';
    }
});

document.getElementById('hotkeys-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const blocks = document.querySelectorAll('#hotkeys-list .data-block');
    let ok = true;
    for (let i = 0; i < blocks.length; i++) {
        const title = blocks[i].querySelector('h3').textContent.trim();
        // –°–æ–±–∏—Ä–∞–µ–º —Ç—Ä–∏–≥–≥–µ—Ä—ã –∫–∞–∫ –º–∞—Å—Å–∏–≤
        const target = Array.from(blocks[i].querySelectorAll('input[name="target"]'))
            .map(input => input.value.trim())
            .filter(Boolean);
        const wordsRaw = blocks[i].querySelector('input[name="words"]').value.trim();
        let words;
        if (wordsRaw === '') {
            words = [];
        } else if (wordsRaw.includes(',')) {
            words = wordsRaw.split(',').map(s => s.trim()).filter(Boolean);
        } else {
            words = [wordsRaw];
        }
        // –°–æ–±–∏—Ä–∞–µ–º —Ö–æ—Ç–∫–µ–π –∫–∞–∫ –º–∞—Å—Å–∏–≤
        const hotkey = Array.from(blocks[i].querySelectorAll('input[name="hotkey"]'))
            .map(input => input.value.trim())
            .filter(Boolean);
        const flag = blocks[i].querySelector('select[name="flag"]').value;
        const key = Object.keys(commandsData)[i];
        try {
            await axios.put(`/api/hotkeys/${key}`, { title, target, words, hotkey, flag });
        } catch (err) {
            ok = false;
        }
    }
    document.getElementById('save-status').textContent = ok ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!' : '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!';
    setTimeout(() => document.getElementById('save-status').textContent = '', 2000);
    loadCommands();
});

loadAll();
</script>
{% endblock %} 