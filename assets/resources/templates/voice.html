{% extends "base.html" %}
{% block title %}–û–∑–≤—É—á–∫–∏{% endblock %}
{% block content %}
<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
    <h1 style="margin: 0;">–§–ª–∞–≥–∏ –æ–∑–≤—É—á–∫–∏</h1>
    <button id="add-voice-btn" type="button">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ–∑–≤—É—á–∫—É</button>
</div>
<form id="voices-form">
    <div id="voices-list"></div>
    <div class="btn-with-status" style="margin-top: 24px;">
        <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <div id="save-status"></div>
    </div>
</form>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –æ–∑–≤—É—á–∫–∏ -->
<div id="modal-bg" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#181d27; padding:32px 24px; border-radius:12px; min-width:320px; box-shadow:0 2px 12px #000;">
        <h2 style="margin-top:0;">–î–æ–±–∞–≤–∏—Ç—å –æ–∑–≤—É—á–∫—É</h2>
        <form id="add-voice-form">
            <label>
                <span>üìå –§–ª–∞–≥:</span>
                <input type="text" name="flag" required>
                <p class="hint">*–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</p>
            </label>
            <label>
                <span>üóÇÔ∏è –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É:</span>
                <input type="text" name="uri" required>
                <p class="hint">*–î–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ - —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</p>
            </label>
            <div style="display:flex; gap:12px; margin-top:16px;">
                <button type="submit">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                <button type="button" id="close-modal-btn">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div id="add-status"></div>
        </form>
    </div>
</div>

<script>
    let voicesData = {};

    async function loadVoices() {
        const resp = await axios.get('/api/voices');
        voicesData = resp.data;
        renderVoices();
    }

    function renderVoices() {
        const list = document.getElementById('voices-list');
        list.innerHTML = '';
        Object.entries(voicesData).forEach(([flag, v], idx) => {
            let uriValue = Array.isArray(v.uri) ? v.uri.join(', ') : (v.uri || '');
            const block = document.createElement('div');
            block.className = 'data-block';
            block.style.marginBottom = '18px';
            block.innerHTML = `
            <div class="label-flex between">  
                <div>  
                <div class="label-flex" style="margin-bottom:8px;">
                    <span style="min-width:50px;">üìå –§–ª–∞–≥:</span>
                    <input type="text" name="flag" value="${v.flag}" data-idx="${idx}" required class="lg-input">
                    <p class="hint">*–õ—é–±–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤</p>
                </div>
                <div class="label-flex">
                    <span style="min-width:50px;">üóÇÔ∏è –ü—É—Ç—å:</span>
                    <input type="text" name="uri" value="${uriValue}" data-idx="${idx}" required class="lg-input">
                    <p class="hint">*–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É files/voices/name/<span class="primary">–ø—É—Ç—å.wav</span></p>
                </div>
                </div>
                    <div style="align-items:end;height:100%;">
                        <button type="button" class="delete-voice-btn" data-flag="${flag}" style="background:#a33;">–£–¥–∞–ª–∏—Ç—å</button>
                    <div>
                </div>
            `;
            list.appendChild(block);

            const deleteBtn = block.querySelector('.delete-voice-btn');
            deleteBtn.onclick = async function() {
                if (confirm(`–£–¥–∞–ª–∏—Ç—å –æ–∑–≤—É—á–∫—É "${flag}"?`)) {
                    try {
                        await axios.delete(`/api/voices/${flag}`);
                        loadVoices();
                    } catch (err) {
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è!');
                    }
                }
            };
        });
    }

    // –ú–æ–¥–∞–ª–∫–∞
    const modalBg = document.getElementById('modal-bg');
    document.getElementById('add-voice-btn').onclick = () => { modalBg.style.display = 'flex'; };
    document.getElementById('close-modal-btn').onclick = () => { modalBg.style.display = 'none'; };

    document.getElementById('add-voice-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target;
        const uriRaw = form.uri.value.trim();
        let uri;
        if (uriRaw === '') {
            uri = [];
        } else if (uriRaw.includes(',')) {
            uri = uriRaw.split(',').map(s => s.trim()).filter(Boolean);
        } else {
            uri = uriRaw;
        }
        const data = {
            flag: form.flag.value.trim(),
            uri
        };
        try {
            await axios.post('/api/voices', data);
            document.getElementById('add-status').textContent = '–î–æ–±–∞–≤–ª–µ–Ω–æ!';
            form.reset();
            setTimeout(() => {
                document.getElementById('add-status').textContent = '';
                modalBg.style.display = 'none';
            }, 1000);
            loadVoices();
        } catch (err) {
            document.getElementById('add-status').textContent = '–û—à–∏–±–∫–∞!';
        }
    });

    document.getElementById('voices-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ñ–æ—Ä–º—ã
        const blocks = document.querySelectorAll('#voices-list .data-block');
        let ok = true;
        for (let i = 0; i < blocks.length; i++) {
            const flag = blocks[i].querySelector('input[name="flag"]').value.trim();
            const uriRaw = blocks[i].querySelector('input[name="uri"]').value.trim();
            let uri;
            if (uriRaw === '') {
                uri = [];
            } else if (uriRaw.includes(',')) {
                uri = uriRaw.split(',').map(s => s.trim()).filter(Boolean);
            } else {
                uri = uriRaw;
            }
            try {
                await axios.put(`/api/voices/${Object.keys(voicesData)[i]}`, { flag, uri });
            } catch (err) {
                ok = false;
            }
        }
        document.getElementById('save-status').textContent = ok ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!' : '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!';
        setTimeout(() => document.getElementById('save-status').textContent = '', 2000);
        loadVoices();
    });

    loadVoices();
</script>
{% endblock %} 