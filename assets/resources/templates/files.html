{% extends "base.html" %}
{% block title %}–§–∞–π–ª—ã{% endblock %}
{% block content %}
<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
    <h1 style="margin: 0;">–§–∞–π–ª—ã</h1>
    <button id="add-file-btn" type="button">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª</button>
</div>
<form id="files-form">
    <div id="files-list"></div>
    <div class="btn-with-status" style="margin-top: 24px;">
        <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <div id="save-status"></div>
    </div>
</form>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ -->
<div id="modal-bg" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#181d27; padding:32px 24px; border-radius:12px; min-width:320px; box-shadow:0 2px 12px #000;">
        <h2 style="margin-top:0;">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª</h2>
        <form id="add-file-form">
            <label>
                <span>üîë –ö–ª—é—á:</span>
                <input type="text" name="title" required>
                <p class="hint">*–ò–º—è —Ñ–∞–π–ª–∞ (–ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ)</p>
            </label>
            <label>
                <span>üí≠ –ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</span>
                <input type="text" name="words" required>
                <p class="hint">*–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∞–π–ª–∞</p>
            </label>
            <label>
                <span>üóÇÔ∏è –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É:</span>
                <input type="text" name="path" required>
                <p class="hint">*–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ –∏–ª–∏ —Ñ–∞–π–ª—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, C:\\Users\\User\\file.txt)</p>
            </label>
            <label style="display: block; width: 100%;">
                <span style="display: block; margin-bottom: 6px;">üìå –§–ª–∞–≥ –æ–∑–≤—É—á–∫–∏:</span>
                <select name="flag" id="add-flag-select" style="width: 100%; box-sizing: border-box;">
                    <option value="">–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</option>
                </select>
                <p class="hint" style="margin-top: 4px;">*–§–ª–∞–≥ –æ–∑–≤—É—á–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞</p>
            </label>
            <div style="display:flex; gap:12px; margin-top:16px;">
                <button type="submit">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                <button type="button" id="close-modal-btn">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div id="add-status"></div>
        </form>
    </div>
</div>

<script>
let filesData = {};
let voiceFlags = [];

async function loadFiles() {
    const resp = await axios.get('/api/files');
    filesData = resp.data;
    await loadVoiceFlags();
    renderFiles();
}

async function loadVoiceFlags() {
    const resp = await axios.get('/api/voice/flags');
    voiceFlags = resp.data;
}

function renderFiles() {
    const list = document.getElementById('files-list');
    list.innerHTML = '';
    Object.entries(filesData).forEach(([key, v], idx) => {
        let wordsValue = Array.isArray(v.words) ? v.words.join(', ') : (v.words || '');
        const block = document.createElement('div');
        block.className = 'data-block';
        block.style.marginBottom = '18px';
        block.innerHTML = `
            <div class="label-flex between">
                <div>
                    <h3 style="margin:0 0 16px 0;">${key}</h3>
                    <div class="label-flex" style="margin-bottom:8px;">
                        <span style="min-width:80px;">üí≠ –§—Ä–∞–∑—ã:</span>
                        <input type="text" name="words" value="${wordsValue}" data-idx="${idx}" required class="lg-input">
                        <p class="hint">*–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</p>
                    </div>
                    <div class="label-flex" style="margin-bottom:8px;">
                        <span style="min-width:80px;">üóÇÔ∏è –ü—É—Ç—å:</span>
                        <input type="text" name="path" value="${v.uri || ''}" data-idx="${idx}" required class="lg-input">
                        <p class="hint">*–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ –∏–ª–∏ —Ñ–∞–π–ª—É</p>
                    </div>
                    <div class="label-flex" style="margin-top:8px; align-items: center;">
                        <span style="min-width:80px; margin-bottom: 4px;">üìå –§–ª–∞–≥:</span>
                        <div class="flag-select-container" style="width:345px;"></div>
                        <p class="hint" style="margin-top: 4px;">*–§–ª–∞–≥ –æ–∑–≤—É—á–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞</p>
                    </div>
                </div>
                <div style="align-items:end;height:100%;">
                    <button type="button" class="delete-file-btn" data-key="${key}" style="background:#a33;">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
        `;
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
        const deleteBtn = block.querySelector('.delete-file-btn');
        deleteBtn.onclick = async function() {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª "${key}"?`)) {
                try {
                    await axios.delete(`/api/files/${key}`);
                    loadFiles();
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è!');
                }
            }
        };
        const flagSelect = document.createElement('select');
        flagSelect.name = 'flag';
        flagSelect.className = 'lg-input';
        flagSelect.style = "width:345px;"
        flagSelect.setAttribute('data-idx', idx);

        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        const noneOption = document.createElement('option');
        noneOption.value = '';
        noneOption.textContent = '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
        if (!v.flag || v.flag === '') noneOption.selected = true;
        flagSelect.appendChild(noneOption);

        voiceFlags.forEach(flag => {
            const option = document.createElement('option');
            option.value = flag;
            option.textContent = flag;
            if (v.flag === flag) option.selected = true;
            flagSelect.appendChild(option);
        });

        const flagDiv = block.querySelector('.flag-select-container');
        flagDiv.appendChild(flagSelect);
        list.appendChild(block);
    });
}

// –ú–æ–¥–∞–ª–∫–∞
const modalBg = document.getElementById('modal-bg');
document.getElementById('add-file-btn').onclick = () => { modalBg.style.display = 'flex'; };
document.getElementById('close-modal-btn').onclick = () => { modalBg.style.display = 'none'; };

// –ó–∞–ø–æ–ª–Ω—è–µ–º select –≤ –º–æ–¥–∞–ª–∫–µ
function fillAddFlagSelect() {
    const addFlagSelect = document.getElementById('add-flag-select');
    addFlagSelect.innerHTML = '<option value="">–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</option>';
    voiceFlags.forEach(flag => {
        const option = document.createElement('option');
        option.value = flag;
        option.textContent = flag;
        addFlagSelect.appendChild(option);
    });
}

// –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–ª–∞–≥–æ–≤ –∑–∞–ø–æ–ª–Ω—è–µ–º select
async function loadAll() {
    await loadVoiceFlags();
    fillAddFlagSelect();
    await loadFiles();
}

// –ú–æ–¥–∞–ª–∫–∞: –æ–±–Ω–æ–≤–ª—è—Ç—å select –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
modalBg.addEventListener('show', fillAddFlagSelect);
document.getElementById('add-file-btn').onclick = () => { 
    fillAddFlagSelect();
    modalBg.style.display = 'flex'; 
};
document.getElementById('close-modal-btn').onclick = () => { modalBg.style.display = 'none'; };

document.getElementById('add-file-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const wordsRaw = form.words.value.trim();
    let words;
    if (wordsRaw === '') {
        words = [];
    } else if (wordsRaw.includes(',')) {
        words = wordsRaw.split(',').map(s => s.trim()).filter(Boolean);
    } else {
        words = [wordsRaw];
    }
    const data = {
        title: form.title.value.trim(),
        words,
        path: form.path.value.trim(),
        flag: form.flag.value
    };
    try {
        await axios.post('/api/files', data);
        document.getElementById('add-status').textContent = '–î–æ–±–∞–≤–ª–µ–Ω–æ!';
        form.reset();
        setTimeout(() => {
            document.getElementById('add-status').textContent = '';
            modalBg.style.display = 'none';
        }, 1000);
        loadFiles();
    } catch (err) {
        document.getElementById('add-status').textContent = '–û—à–∏–±–∫–∞!';
    }
});

document.getElementById('files-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const blocks = document.querySelectorAll('#files-list .data-block');
    let ok = true;
    for (let i = 0; i < blocks.length; i++) {
        const wordsRaw = blocks[i].querySelector('input[name="words"]').value.trim();
        let words;
        if (wordsRaw === '') {
            words = [];
        } else if (wordsRaw.includes(',')) {
            words = wordsRaw.split(',').map(s => s.trim()).filter(Boolean);
        } else {
            words = [wordsRaw];
        }
        const uri = blocks[i].querySelector('input[name="path"]').value.trim();
        const flag = blocks[i].querySelector('select[name="flag"]').value;
        const key = Object.keys(filesData)[i];
        try {
            await axios.put(`/api/files/${key}`, { words, uri, flag });
        } catch (err) {
            ok = false;
        }
    }
    document.getElementById('save-status').textContent = ok ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!' : '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!';
    setTimeout(() => document.getElementById('save-status').textContent = '', 2000);
    loadFiles();
});

loadAll();
</script>
{% endblock %} 